---
title: "Stats 101C Regression Final"
author: "Group 13"
date: "`r Sys.Date()`"
output:
  html:
embed-resources: true
---

```{r}
# Load datasets
purchases <- read.csv("amazon-purchases.csv")
survey <- read.csv("survey_train_test.csv")

# Merge datasets on Survey Response ID
data <- base::merge(purchases, survey, by = "Survey.ResponseID")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=7, fig.height=5)
library(tidyverse)
library(rpart)
library(mlr3verse)
library(ggplot2)
library(xgboost)
library(dplyr)

```

## Introduction 
Research shows that factors such as income, age, gender, and household composition often influence spending behavior and product choice (U.S. Bureau of Labor Statistics). This background makes us interested to see if online spending is associated with variables such as income, education, age, and household sizes. The household size could be associated with how often and how many products are typically purchased but the different demographics of the customer or household could be associated with the purchase category. Personal habits and factors related to personal health could also place an influential role in purchasing behavior. These variables are all plausible predictors of online spending behavior.

## Exploratory Data Analysis
As we explored potential relationships between the variables, notable patterns were discovered and some failed to showed. Our findings are presented below: 

```{r, fig.width=10, fig.height=6}
# Select numeric variables
numeric_data <- data %>%
  select(Purchase.Price.Per.Unit, Quantity, Q.amazon.use.howmany, 
         Q.amazon.use.hh.size.num)

# Convert columns to numeric
numeric_data <- numeric_data %>%
  mutate(Q.amazon.use.howmany = as.numeric(Q.amazon.use.howmany))

# Compute correlation matrix
cor_matrix <- cor(numeric_data, use = "pairwise.complete.obs")

# Convert to long format for ggplot
cor_long <- as.data.frame(as.table(cor_matrix))

ggplot(cor_long, aes(Var1, Var2, fill = Freq)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "darkgreen", high = "pink", mid = "white",
                       midpoint = 0, limit = c(-1,1), space = "Lab",
                       name = "Correlation") +
  geom_text(aes(label = round(Freq, 2)), color = "black", size = 4) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Correlation Matrix Heatmap (Numeric Variables)", x = "", y = "")
```
From our correlation heat map, we notice that all the numerical variables do not show any kind of correlation among each other. Surprisingly the household size and the number of users per amazon account doesn't have any correlation to the amount of products purchased. The variable interactions seem to be statistically negligible in terms of a linear relationship. 


```{r, fig.width=10, fig.height=6} 
# Convert age ranges to numeric midpoints
age_data <- data %>%
  mutate(
    q_demos_age = case_when(
      Q.demos.age == "18 - 24 years" ~ (18 + 24)/2,
      Q.demos.age == "25 - 34 years" ~ (25 + 34)/2,
      Q.demos.age == "35 - 44 years" ~ (35 + 44)/2,
      Q.demos.age == "45 - 54 years" ~ (45 + 54)/2,
      Q.demos.age == "55 - 64 years" ~ (55 + 64)/2,
      Q.demos.age == "65 and older" ~ 70, 
      TRUE ~ NA_real_
    )
  )

# Define age groups for faceting
age_data <- age_data %>%
  mutate(Age.Group = cut(q_demos_age, 
                         breaks = c(18, 25, 35, 45, 55, 65, 100), 
                         labels = c("18-24","25-34","35-44","45-54","55-64","65+"),
                         right = FALSE))

ggplot(age_data, aes(x = Q.amazon.use.hh.size.num, 
                     y = Purchase.Price.Per.Unit * Quantity, 
                     fill = factor(Q.amazon.use.hh.size.num))) +
  geom_boxplot() +
  facet_wrap(~Age.Group) +
  labs(title = "Spending by Household Size Across Age Groups", 
       x = "Household Size", 
       y = "Spending per Transaction") +
  theme_minimal()
```
After looking at how different household sizes and age ranges spend money, we noticed that all household sizes tend to have the same distribution of spending habits and those within the 25-34 range tend to spend the most. 

```{r, fig.width=10, fig.height=6}
ggplot(data, aes(x = Shipping.Address.State, y = Q.amazon.use.hh.size.num)) +
  stat_summary(fun = "mean", geom = "bar") +
  labs(title = "Average Housing Size by State",
       x = "State", y = "Mean Housing Size") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Interested in seeing if the state/location would show any noticeable patterns in the housing size, our visual showed that the state doesn't seem to make a difference on the average housing size. This suggests that more populated states might not be very important to consider in our final model. Most states tend to average around 2 to 3 for their household size. Hawaii surprisingly shows the highest average while Puerto Rico shows the smallest, yet they are both very small territories.  


```{r, fig.width=10, fig.height=6}
ggplot(data, aes(x = Q.substance.use.cigarettes, y = Q.amazon.use.hh.size.num, fill = Q.substance.use.cigarettes)) +
  geom_boxplot() +
  labs(title = "Housing Size by Cigarette Use Behavior",
       x = "Cigarette Use Category",
       y = "Housing Size") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Customers that have stopped cigarette use in the past tend to average around a household size of 2 but the IQR of the boxplot spans from 1 to 3 for the household size. Customers that do not use cigarettes tend to average around a household size of 2 but the IQR of the boxplot spans up to 4 for the household size. Customers that prefer not to share average around a household size of 2 but the IQR of the boxplot spans up to 3 for the household size. Customers that do use cigarettes tend to average around a household size of 3 but the IQR of the boxplot spans from 2 to 4 for the household size. Based on the medians of the boxplots, active cigarette users usually have a larger household size, but non cigarette users have a right skewed distribution towards having a larger household size. 

```{r, fig.width=10, fig.height=6}
behavior_data <- data %>%
  select(Q.substance.use.cigarettes,
         Q.substance.use.alcohol,
         Q.substance.use.marijuana,
         Q.amazon.use.hh.size.num) %>%
  pivot_longer(
    cols = starts_with("Q.substance.use"),
    names_to = "Behavior",
    values_to = "Response"
  )

ggplot(behavior_data, aes(x = Response, y = Q.amazon.use.hh.size.num, fill = Response)) +
  geom_boxplot() +
  facet_wrap(~Behavior, scales = "free_x") +
  labs(
    title = "Housing Size Across Multiple Behavioral Factors",
    x = "Response",
    y = "Housing Size"
  ) +
  theme_minimal()
```
After seeing the results of cigarette use in the household on the household size, we wanted to see if that pattern would be the same for other drug use variables. We notice that this was the case and the customers that did not use any drugs showed again as having the right skew trend of having larger families with a median of 2. Alcohol users had the same pattern as non-users but those that used marijuana showed had a smaller IQR that went up to a household size of 3. Across all panels, users that stopped drug use in the past still have the same observed results as the previous plot. Those who prefer to not say either had a median size of 2 or would have a right skewed distribution with the IQR going up to a size of 3. 

```{r, fig.width=10, fig.height=6}
par(mfrow = c(1, 2))  

# Histogram for numeric reported housing size
print(
  ggplot(data, aes(x = Q.amazon.use.hh.size.num)) +
    geom_histogram(bins = 20, fill = "skyblue", color = "black") +
    labs(
      title = "Distribution of Housing Size (Numeric)",
      x = "Housing Size (Numeric)",
      y = "Count"
    ) +
    theme_minimal()
)

# Bar chart for categorical reported housing size
print(
  ggplot(data, aes(x = Q.amazon.use.hh.size)) +
    geom_bar(fill = "lightgreen", color = "black") +
    labs(
      title = "Distribution of Housing Size (Categorical)",
      x = "Housing Size (Category)",
      y = "Count"
    ) +
    theme_minimal()
)
```
Just looking at the distribution of housing sizes, we see that it's more common for households to have a size of 2, then 4+, and a size of 1 or 3 share the same frequency. Since household sizes of 4 and more are represented by only one variable, it's difficult to tell what the breakdown of household sizes are within that variable, but it's clear that having a large family, where large is defined by 4 or more, is more frequent than a family size of 1 or 3.   

```{r, fig.width=10, fig.height=6}
ggplot(data, aes(x = Q.amazon.use.hh.size.num, fill = Q.demos.income)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Counts of Housing Sizes, Broken Down by Income Range",
    x = "Housing Size",
    y = "Count",
    fill = "Income Range"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0))

```
We assumed that larger household sizes would most likely make a larger income. We do see that household sizes of 4 or more frequently make an income within 100-150K but those that make 150K or more are not the most frequent income range to have large families. The same pattern is seen for household sizes of 2. The majority of those that are a household size of 1 had an income under 75K, which was expected. However, across all income ranges, those that had a household size of 3 had somewhat similar frequencies in their income ranges, and surprisingly, those making 50-75K was the most frequent.  

## Preprocessing
```{r}
## Drop unnecessary columns 
cols_to_drop <- c("Q.sell.YOUR.data", "Q.sell.consumer.data", "Q.small.biz.use", "Q.census.use", "Q.research.society", "test")
survey <- survey %>% select(setdiff(colnames(survey), cols_to_drop))
```
The variables related to the usage of personal information did not feel relevant to our goal of being able to predict the household size of a customer using their purchasing behavior






## Candidate models / Model evaluation / Tuning
```{r}

```



## Final Model
```{r}

```




